<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SP réalité virtuelle</title>
    <!-- A-Frame + Téléport + Physique -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-cursor-teleport@1.6.0/dist/aframe-cursor-teleport-component.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-system@5.0.0/dist/aframe-physics-system.min.js"></script>

    <!-- Composant de zone -->
    <script>
      AFRAME.registerComponent("zone-listener", {
        schema: { zone: { type: "selector" } },
        init: function () {
          this.inZone = false;
        },
        tick: function () {
          const camPos = document
            .querySelector("#cameraRig")
            .getAttribute("position");
          const box = this.data.zone.getAttribute("geometry");
          const zp = this.data.zone.getAttribute("position");
          const dx = camPos.x - zp.x,
            dy = camPos.y - zp.y,
            dz = camPos.z - zp.z;
          const hx = box.width / 2,
            hy = box.height / 2,
            hz = box.depth / 2;
          const inside =
            Math.abs(dx) <= hx && Math.abs(dy) <= hy && Math.abs(dz) <= hz;
          if (inside && !this.inZone) {
            this.inZone = true;
            this.el.emit("zoneEnter");
          } else if (!inside && this.inZone) {
            this.inZone = false;
            this.el.emit("zoneExit");
          }
        },
      });
    </script>

    <!-- Partie Claudia (archery-game + zone-panel définis ici) -->
    <script src="blocks/archery-game/archery-component.js"></script>
    <script src="blocks/archery-game/archery.js"></script>
  </head>

  <body>
    <a-scene
      physics="gravity: -9.8"
      zone-listener="zone: #archery-zone"
      zone-panel
    >
      <a-assets>
        <img src="ressources/images/sky.jpeg" id="sky" />
        <audio
          id="music"
          src="ressources/sound/kids-game-gaming-background-music-295075.mp3"
          preload="auto"
        ></audio>
        <a-asset-item
          src="ressources/village/scene.gltf"
          id="village"
        ></a-asset-item>
        <!-- cible 3D -->
        <a-asset-item
          id="targetModel"
          src="blocks/archery-game/assets/textures/target.glb"
        ></a-asset-item>
      </a-assets>

      <a-sky src="#sky"></a-sky>

      <!-- Village (Julie) -->
      <a-gltf-model
        position="0 0 0"
        scale="20 20 20"
        src="#village"
        class="clickable"
        static-body
        make-gltf-clickable
      ></a-gltf-model>

      <a-entity id="julie" position="-5 0 3" rotation="0 90 0">
        <a-entity id="cubes-jeu"></a-entity>
        <a-entity id="panneau-jeu" position="-1.3 1 2.5" rotation="0 40 0">
          <a-text
            value="Jeu des 10 cubes"
            color="#FFAA00"
            align="center"
            width="2"
            position="0 0.2 0"
            font="mozillavr"
          ></a-text>
          <a-text
            value="Touchez les cubes numérotés de 1 à 10 dans l'ordre.\nÉvitez les erreurs !"
            color="#FFFFFF"
            align="center"
            width="1.5"
            position="0 0 0"
            font="mozillavr"
          ></a-text>
        </a-entity>
      </a-entity>

      <!-- Partie Claudia - Panneau d’orientation (toujours visible hors zone) -->
      <a-entity
        id="panneau-orient"
        position="0.667 0.551 8.162"
        rotation="0 200 0"
      >
        <a-plane
          width="2"
          height="1"
          material="color:#FFD700; opacity:0.8; transparent:true"
        ></a-plane>
        <a-text value="Visée Médiévale ! Par ici !"
          color="#000"
          align="center"
          width="1.8"
          position="0 0.25 0.01"
          font="mozillavr">
        </a-text>
        <a-text
          value="←"
          color="#000"
          align="center"
          width="1"
          position="-0.8 -0.2 0.01"
        ></a-text>
      </a-entity>
      <a-entity
        id="archery-zone"
        geometry="primitive: box; width: 6; height: 4; depth: 8"
        position="1.3 1.5 9"
        material="opacity:0; transparent:true"
      ></a-entity>
      <a-entity
        id="claudia"
        position="1.3 0 8"
        rotation="0 180 0"
        archery-game
      ></a-entity>

      <!-- Partie Emeline -->
      <a-entity id="emeline" position="3 0 -10">
        <a-cylinder
          color="blue"
          position="0 1 0"
          radius="1"
          height="2"
        ></a-cylinder>
        <a-text
          value="Partie Emeline"
          position="-0.5 1 1.5"
          color="white"
        ></a-text>
      </a-entity>

      <!-- Caméra & Téléport -->
      <a-entity
        id="cameraRig"
        cursor-teleport="cameraRig: #cameraRig; cameraHead: #head; collisionEntities: .clickable; cursorColor: #ffffff;"
      >
        <a-entity
          id="head"
          position="0 0.55 0"
          camera
          look-controls="reverseMouseDrag: true"
        >
          <a-entity
            cursor="rayOrigin: mouse"
            geometry="primitive: ring; radiusInner:0.005; radiusOuter:0.01"
            material="shader: flat; color: white; opacity:0.75"
            raycaster="objects: .clickable"
          ></a-entity>
        </a-entity>
      </a-entity>

      <!-- Sons -->
      <a-entity id="sound-touch" sound="src: #touch-cube; volume: 2"></a-entity>
      <a-entity id="sound-win" sound="src: #win-cubes; volume: 2.7"></a-entity>
      <a-entity id="sound-lose" sound="src: #lose-cubes; volume: 2"></a-entity>
    </a-scene>

    <script src="./js/index_partie_julie.js"></script>
  </body>
</html>
